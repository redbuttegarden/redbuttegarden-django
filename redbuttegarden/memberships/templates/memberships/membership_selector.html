{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Find a membership</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="{% static 'redbuttegarden/css/theme.css' %}" />

    <style>
      .btn-rbg-primary {
        background-color: var(--rbg-oak-green);
        border-color: var(--rbg-oak-green);
        color: #fff;
      }
      .btn-rbg-primary:hover {
        background-color: color-mix(in srgb, var(--rbg-oak-green) 85%, black 15%);
        border-color: color-mix(in srgb, var(--rbg-oak-green) 85%, black 15%);
      }
      .card-rbg {
        border: 1px solid rgba(var(--rbg-dark-blue-rgb), 0.08);
        box-shadow: 0 6px 18px rgba(var(--rbg-dark-blue-rgb), 0.03);
      }
      .priority-item {
        cursor: grab;
      }
      .priority-item:active {
        cursor: grabbing;
      }
      .priority-handle {
        width: 36px;
      }
      .sr-only-focusable:focus {
        position: static;
        clip: auto;
        width: auto;
        height: auto;
        overflow: visible;
      }
      .range-value {
        min-width: 2.2rem;
        display: inline-block;
        text-align: center;
      }
    </style>

    <!-- htmx -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  </head>

  <body class="bg-light" style="font-family: var(--rbg-font-family);">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-9">
          <div class="card card-rbg mb-4">
            <div class="card-body">
              <h1 class="h4 mb-1" style="color:var(--rbg-dark-blue)">Find the best membership for you</h1>
              <p class="text-muted mb-0">Choose your needs, then drag to order which factor matters most.</p>
            </div>
          </div>

          <div class="card card-rbg mb-4">
            <div class="card-body">
              <form method="post" action="{% url 'members:membership_suggest' %}" hx-post="{% url 'members:membership_suggest' %}" hx-target="#suggestions" hx-swap="innerHTML">
                {% csrf_token %}

                <!-- Needs (unchanged) -->
                <div class="mb-4">
                  <h2 class="h6">Your needs</h2>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label" for="{{ form.cardholders.id_for_label }}">{{ form.cardholders.label }}</label>
                      {{ form.cardholders }}
                    </div>

                    <div class="col-md-4">
                      <label class="form-label" for="{{ form.admissions.id_for_label }}">{{ form.admissions.label }}</label>
                      {{ form.admissions }}
                    </div>

                    <div class="col-md-4">
                      <label class="form-label" for="{{ form.member_tickets.id_for_label }}">{{ form.member_tickets.label }}</label>
                      {{ form.member_tickets }}
                    </div>
                  </div>
                </div>

                <!-- Sortable priorities (default: Tickets -> Admissions -> Cardholders) -->
                <div class="mb-4">
                  <h2 class="h6">Drag to set priority</h2>
                  <p class="text-muted small mb-2">Top = highest priority.</p>

                  <ul id="priority-list" class="list-group" role="list" aria-label="Priority list">
                    <!-- tickets item (default top) -->
                    <li class="list-group-item d-flex align-items-center priority-item" role="listitem" draggable="true" data-key="tickets" aria-grabbed="false">
                      <span class="priority-handle me-3 text-muted" aria-hidden="true"><i class="bi bi-grip-vertical"></i></span>
                      <div class="flex-grow-1">
                        <div class="fw-semibold">Tickets</div>
                        <div class="small text-muted">Member-sale ticket allowance</div>
                      </div>
                      <div class="ms-3">
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1 btn-move-up" aria-label="Move Tickets up"><i class="bi bi-arrow-up"></i></button>
                        <button type="button" class="btn btn-sm btn-outline-secondary btn-move-down" aria-label="Move Tickets down"><i class="bi bi-arrow-down"></i></button>
                      </div>
                    </li>

                    <!-- admissions item -->
                    <li class="list-group-item d-flex align-items-center priority-item" role="listitem" draggable="true" data-key="admissions" aria-grabbed="false">
                      <span class="priority-handle me-3 text-muted" aria-hidden="true"><i class="bi bi-grip-vertical"></i></span>
                      <div class="flex-grow-1">
                        <div class="fw-semibold">Admissions</div>
                        <div class="small text-muted">How many people can enter per visit</div>
                      </div>
                      <div class="ms-3">
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1 btn-move-up" aria-label="Move Admissions up"><i class="bi bi-arrow-up"></i></button>
                        <button type="button" class="btn btn-sm btn-outline-secondary btn-move-down" aria-label="Move Admissions down"><i class="bi bi-arrow-down"></i></button>
                      </div>
                    </li>

                    <!-- cardholders item -->
                    <li class="list-group-item d-flex align-items-center priority-item" role="listitem" draggable="true" data-key="cardholders" aria-grabbed="false">
                      <span class="priority-handle me-3 text-muted" aria-hidden="true"><i class="bi bi-grip-vertical"></i></span>
                      <div class="flex-grow-1">
                        <div class="fw-semibold">Cardholders</div>
                        <div class="small text-muted">How many names appear on the membership card</div>
                      </div>
                      <div class="ms-3">
                        <button type="button" class="btn btn-sm btn-outline-secondary me-1 btn-move-up" aria-label="Move Cardholders up"><i class="bi bi-arrow-up"></i></button>
                        <button type="button" class="btn btn-sm btn-outline-secondary btn-move-down" aria-label="Move Cardholders down"><i class="bi bi-arrow-down"></i></button>
                      </div>
                    </li>
                  </ul>
                </div>

                <!-- Hidden weight inputs (kept hidden so backend gets weights but users don't see them) -->
                <div class="visually-hidden">{{ form.admissions_weight }}
                  {{ form.cardholders_weight }}
                  {{ form.tickets_weight }}</div>

                <!-- Submit button -->
                <div class="d-flex justify-content-end">
                  <button type="submit" class="btn btn-rbg-primary"><i class="bi bi-search me-2"></i>Find best match</button>
                </div>
              </form>
            </div>
          </div>

          <!-- results container updated by HTMX -->
          <div id="suggestions" class="mt-4" aria-live="polite">
            <div class="card card-rbg">
              <div class="card-body">
                <p class="text-muted mb-0">
                  Enter values and click <strong>Find best match</strong>.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JS: drag/drop + keyboard reordering + mapping to weights + HTMX afterSwap scroll -->
    <script>
      ;(function () {
        // rank -> weight mapping
        const rankToWeight = [10, 6, 2] // index 0 = first place
      
        const list = document.getElementById('priority-list')
      
        // helper: update hidden inputs and badges based on current order
        function updateWeightsFromOrder() {
          const items = Array.from(list.querySelectorAll('li[data-key]'))
          items.forEach((item, idx) => {
            const key = item.dataset.key // "admissions" | "cardholders" | "tickets"
            const weight = rankToWeight[idx] || 0
      
            // update visible badge
            const badge = list.querySelector('.badge-weight[data-key="' + key + '"]')
            if (badge) badge.textContent = weight
      
            // set hidden input values (the inputs have ids from forms.py)
            if (key === 'admissions') {
              const el = document.getElementById('id_admissions_weight')
              if (el) el.value = weight
            } else if (key === 'cardholders') {
              const el = document.getElementById('id_cardholders_weight')
              if (el) el.value = weight
            } else if (key === 'tickets') {
              const el = document.getElementById('id_tickets_weight')
              if (el) el.value = weight
            }
          })
        }
      
        // initial mapping on load
        document.addEventListener('DOMContentLoaded', function () {
          updateWeightsFromOrder()
          attachDragHandlers()
          attachMoveButtons()
        })
      
        // --- Drag & drop handlers ---
        let dragSrcEl = null
      
        function handleDragStart(e) {
          dragSrcEl = this
          this.classList.add('dragging')
          this.setAttribute('aria-grabbed', 'true')
          e.dataTransfer.effectAllowed = 'move'
          try {
            // required for Firefox
            e.dataTransfer.setData('text/plain', this.dataset.key)
          } catch (err) {
            /* ignore */
          }
        }
      
        function handleDragOver(e) {
          if (e.preventDefault) e.preventDefault() // allow drop
          e.dataTransfer.dropEffect = 'move'
          const target = closestListItem(e.target)
          if (!target || target === dragSrcEl) return
          // show insertion position
          const rect = target.getBoundingClientRect()
          const next = e.clientY - rect.top > rect.height / 2
          target.parentNode.insertBefore(dragSrcEl, next ? target.nextSibling : target)
        }
      
        function handleDragEnd() {
          this.classList.remove('dragging')
          this.setAttribute('aria-grabbed', 'false')
          updateWeightsFromOrder()
        }
      
        function closestListItem(el) {
          while (el && el !== list) {
            if (el.matches && el.matches('li[data-key]')) return el
            el = el.parentNode
          }
          return null
        }
      
        function attachDragHandlers() {
          const items = list.querySelectorAll('li[data-key]')
          items.forEach((item) => {
            item.addEventListener('dragstart', handleDragStart, false)
            item.addEventListener('dragover', handleDragOver, false)
            item.addEventListener('dragend', handleDragEnd, false)
            // make the handle keyboard-focusable
            const handle = item.querySelector('.priority-handle')
            if (handle) handle.setAttribute('tabindex', '0')
          })
      
          // allow dropping by preventing default on the list container
          list.addEventListener(
            'dragover',
            function (e) {
              e.preventDefault()
            },
            false
          )
        }
      
        // --- Up / Down buttons for keyboard accessibility ---
        function attachMoveButtons() {
          list.addEventListener('click', function (e) {
            const up = e.target.closest('.btn-move-up')
            const down = e.target.closest('.btn-move-down')
            if (up || down) {
              const li = e.target.closest('li[data-key]')
              if (!li) return
              if (up) moveItemUp(li)
              if (down) moveItemDown(li)
              updateWeightsFromOrder()
            }
          })
      
          // keyboard support for moving items (Enter on handle toggles nothing by default)
          list.addEventListener('keydown', function (e) {
            const handle = e.target.closest('.priority-handle')
            if (!handle) return
            const li = handle.closest('li[data-key]')
            if (!li) return
            if (e.key === 'ArrowUp') {
              e.preventDefault()
              moveItemUp(li)
              updateWeightsFromOrder()
              li.focus()
            } else if (e.key === 'ArrowDown') {
              e.preventDefault()
              moveItemDown(li)
              updateWeightsFromOrder()
              li.focus()
            }
          })
        }
      
        function moveItemUp(li) {
          if (li.previousElementSibling) {
            li.parentNode.insertBefore(li, li.previousElementSibling)
          }
        }
        function moveItemDown(li) {
          if (li.nextElementSibling) {
            li.parentNode.insertBefore(li.nextElementSibling, li)
          }
        }
      
        // HTMX: after swap, scroll & focus results
        document.body.addEventListener('htmx:afterSwap', function (event) {
          if (event.detail && event.detail.target && event.detail.target.id === 'suggestions') {
            const el = event.detail.target
            el.setAttribute('tabindex', '-1')
            el.focus({ preventScroll: true })
            el.scrollIntoView({ behavior: 'smooth', block: 'start' })
          }
        })
      })()
    </script>
  </body>
</html>
