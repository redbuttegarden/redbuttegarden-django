{% extends 'base.html' %}
{% load static wagtailcore_tags %}

{% block title %}
  Find a membership
{% endblock %}

{# Page-specific CSS: put rules here or move into theme.css per your preference #}
{% block extra_css %}
  <link href="{% static 'memberships/css/membership_widget.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-9">
        <div class="card card-rbg mb-4">
          <div class="card-body">
            <h1 class="h4 mb-1" style="color:var(--rbg-dark-blue)">Find the best membership for you</h1>
            <p class="text-muted mb-0">Choose your needs, then drag to order which factor matters most.</p>
          </div>
        </div>

        <div class="card card-rbg mb-4">
          <div class="card-body">
            <form method="post" action="{% url 'members:membership_suggest' %}" hx-post="{% url 'members:membership_suggest' %}" hx-target="#suggestions" hx-swap="innerHTML">
              {% csrf_token %}

              <!-- Needs -->
              <div class="mb-4">
                <h2 class="h6">Your needs</h2>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label" for="{{ form.cardholders.id_for_label }}">{{ form.cardholders.label }}</label>
                    {{ form.cardholders }}
                  </div>

                  <div class="col-md-4">
                    <label class="form-label" for="{{ form.admissions.id_for_label }}">{{ form.admissions.label }}</label>
                    {{ form.admissions }}
                  </div>

                  <div class="col-md-4">
                    <label class="form-label" for="{{ form.member_tickets.id_for_label }}">{{ form.member_tickets.label }}</label>
                    {{ form.member_tickets }}
                  </div>
                </div>
              </div>

              <!-- Sortable priorities -->
              <div class="mb-4">
                <h2 class="h6">Drag to set priority</h2>
                <p class="text-muted small mb-2">Top = highest priority.</p>

                <ul id="priority-list" class="list-group" role="list" aria-label="Priority list">
                  <li class="list-group-item d-flex align-items-center priority-item" role="listitem" draggable="true" data-key="tickets" aria-grabbed="false">
                    <span class="priority-handle me-3 text-muted" aria-hidden="true"><i class="bi bi-grip-vertical"></i></span>
                    <div class="flex-grow-1">
                      <div class="fw-semibold">Tickets</div>
                      <div class="small text-muted">Member-sale ticket allowance</div>
                    </div>
                    <div class="ms-3">
                      <button type="button" class="btn btn-sm btn-outline-secondary me-1 btn-move-up" aria-label="Move Tickets up"><i class="bi bi-arrow-up"></i></button>
                      <button type="button" class="btn btn-sm btn-outline-secondary btn-move-down" aria-label="Move Tickets down"><i class="bi bi-arrow-down"></i></button>
                    </div>
                  </li>

                  <li class="list-group-item d-flex align-items-center priority-item" role="listitem" draggable="true" data-key="admissions" aria-grabbed="false">
                    <span class="priority-handle me-3 text-muted" aria-hidden="true"><i class="bi bi-grip-vertical"></i></span>
                    <div class="flex-grow-1">
                      <div class="fw-semibold">Admissions</div>
                      <div class="small text-muted">How many people can enter per visit</div>
                    </div>
                    <div class="ms-3">
                      <button type="button" class="btn btn-sm btn-outline-secondary me-1 btn-move-up" aria-label="Move Admissions up"><i class="bi bi-arrow-up"></i></button>
                      <button type="button" class="btn btn-sm btn-outline-secondary btn-move-down" aria-label="Move Admissions down"><i class="bi bi-arrow-down"></i></button>
                    </div>
                  </li>

                  <li class="list-group-item d-flex align-items-center priority-item" role="listitem" draggable="true" data-key="cardholders" aria-grabbed="false">
                    <span class="priority-handle me-3 text-muted" aria-hidden="true"><i class="bi bi-grip-vertical"></i></span>
                    <div class="flex-grow-1">
                      <div class="fw-semibold">Cardholders</div>
                      <div class="small text-muted">How many names appear on the membership card</div>
                    </div>
                    <div class="ms-3">
                      <button type="button" class="btn btn-sm btn-outline-secondary me-1 btn-move-up" aria-label="Move Cardholders up"><i class="bi bi-arrow-up"></i></button>
                      <button type="button" class="btn btn-sm btn-outline-secondary btn-move-down" aria-label="Move Cardholders down"><i class="bi bi-arrow-down"></i></button>
                    </div>
                  </li>
                </ul>
              </div>

              {# Hidden weight inputs (submitted to server) #}
              <div class="visually-hidden">{{ form.admissions_weight }}
                {{ form.cardholders_weight }}
                {{ form.tickets_weight }}</div>

              <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-rbg-primary"><i class="bi bi-search me-2"></i>Find best match</button>
              </div>
            </form>
          </div>
        </div>

        <!-- results container updated by HTMX -->
        <div id="suggestions" class="mt-4" aria-live="polite">
          <div class="card card-rbg">
            <div class="card-body">
              <p class="text-muted mb-0">
                Enter values and click <strong>Find best match</strong>.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="{% static 'memberships/js/membership_widget.js' %}"></script>
  
{% endblock %}
